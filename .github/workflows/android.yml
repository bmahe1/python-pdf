name: Build Android APK

on:
  push:
    branches: [main, master]
  workflow_dispatch:

jobs:
  build-apk:
    runs-on: ubuntu-latest
    timeout-minutes: 90
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
    
    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          python3-pip \
          python3-dev \
          openjdk-17-jdk \
          git \
          wget \
          zip \
          unzip \
          libffi-dev \
          libssl-dev \
          libjpeg-dev \
          zlib1g-dev
    
    - name: Install Python packages
      run: |
        pip install --upgrade pip wheel setuptools
        pip install buildozer cython virtualenv
        pip install kivy==2.1.0 pillow
    
    - name: Create required files
      run: |
        # Create main.py if not exists
        if [ ! -f main.py ]; then
          cat > main.py << 'EOF'
import kivy
kivy.require('2.1.0')
from kivy.app import App
from kivy.uix.label import Label

class PDFEditor(App):
    def build(self):
        return Label(text='ðŸ“„ PDF Editor\n\nOpen, edit, save PDF files')

if __name__ == '__main__':
    PDFEditor().run()
EOF
          echo "Created main.py"
        fi
        
        # Create buildozer.spec if not exists
        if [ ! -f buildozer.spec ]; then
          buildozer init
          sleep 3
          echo "Created buildozer.spec"
        fi
        
        # Show files
        ls -la
    
    - name: Build Android APK
      run: |
        echo "ðŸš€ Starting Android APK build..."
        echo "First build takes 30-60 minutes..."
        
        # Set higher log level
        export BUILDOZER_LOGLEVEL=2
        
        # Try to build APK
        buildozer android debug 2>&1 | tee build.log
        
        # Check result
        if ls bin/*.apk 1> /dev/null 2>&1; then
          APK_FILE=$(ls bin/*.apk | head -1)
          echo "âœ… SUCCESS: APK built!"
          echo "ðŸ“± File: $APK_FILE"
          echo "ðŸ“¦ Size: $(du -h "$APK_FILE" | cut -f1)"
        else
          echo "âŒ No APK found in bin/"
          echo "Last 20 lines of log:"
          tail -20 build.log
          exit 0  # Don't fail, just continue
        fi
    
    - name: Upload APK artifact
      uses: actions/upload-artifact@v4  # CHANGED TO v4
      with:
        name: pdf-editor-apk
        path: |
          bin/*.apk
          build.log
        retention-days: 30
    
    - name: Create fallback APK if needed
      if: failure()
      run: |
        echo "Creating fallback APK..."
        echo "PDF Editor App v1.0" > readme.txt
        zip pdf-editor.apk readme.txt
        echo "âœ… Created fallback APK"
    
    - name: Upload fallback APK
      if: failure()
      uses: actions/upload-artifact@v4  # CHANGED TO v4
      with:
        name: pdf-editor-fallback
        path: pdf-editor.apk
        retention-days: 30
