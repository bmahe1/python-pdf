name: Build Android APK

on:
  push:
    branches: [main, master]
  workflow_dispatch:  # Manual trigger button

jobs:
  build-apk:
    runs-on: ubuntu-latest
    timeout-minutes: 60  # 1 hour timeout
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Setup Python 3.10
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
    
    - name: Setup JDK 17
      uses: actions/setup-java@v3
      with:
        distribution: 'temurin'
        java-version: '17'
    
    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          python3-pip \
          openjdk-17-jdk \
          zip unzip \
          git wget \
          libssl-dev libffi-dev \
          libsqlite3-dev \
          zlib1g-dev
    
    - name: Install Python packages
      run: |
        pip install --upgrade pip setuptools wheel
        pip install buildozer cython virtualenv
        pip install kivy==2.1.0 pillow pypdf2
    
    - name: Build Android APK
      run: |
        echo "ðŸš€ Starting Android APK build..."
        echo "This will take 30-60 minutes (first time)..."
        
        # Initialize Buildozer
        buildozer init 2>/dev/null || true
        
        # Build APK
        buildozer -v android debug
        
        # Check result
        if ls bin/*.apk 1> /dev/null 2>&1; then
          APK_FILE=$(ls bin/*.apk | head -1)
          echo "âœ… APK built successfully!"
          echo "ðŸ“± File: $APK_FILE"
          echo "ðŸ“¦ Size: $(du -h "$APK_FILE" | cut -f1)"
        else
          echo "âŒ APK build failed"
          exit 1
        fi
    
    - name: Upload APK as artifact
      uses: actions/upload-artifact@v3
      with:
        name: pdf-editor-apk
        path: bin/*.apk
        retention-days: 30
    
    - name: Create QR Code for download
      run: |
        APK_FILE=$(ls bin/*.apk | head -1)
        APK_NAME=$(basename "$APK_FILE")
        
        # Create QR code for direct download
        echo "Creating QR code..."
        
        cat > QR_INSTRUCTIONS.md << 'EOF'
# ðŸ“± PDF Editor Pro - APK Download

## How to Install on Your Phone:

### Option 1: Scan QR Code (Easiest)
1. Open your phone's camera
2. Point it at the QR code below
3. Tap the link that appears
4. Download and install the APK

### Option 2: Manual Download
1. Go to this workflow's "Artifacts" section
2. Download `pdf-editor-apk.zip`
3. Extract the APK file
4. Transfer to your phone and install

### Installation Steps:
1. Download the APK file
2. Open your phone's File Manager
3. Find the downloaded APK
4. Tap "Install" (enable "Unknown sources" if needed)
5. Open the app!

---

## App Features:
- ðŸ“„ Open PDF files
- âœï¸ Edit text content
- ðŸ’¾ Save edited PDFs
- ðŸ”„ Merge multiple PDFs
- ðŸ“¤ Export to different formats

---

## QR Code for Download:
![QR Code](https://api.qrserver.com/v1/create-qr-code/?size=300x300&data=https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})

---

*Built with â¤ï¸ using GitHub Actions â€¢ Kivy â€¢ Python*
EOF
        
        echo "ðŸ“„ Created download instructions"
